#!/bin/bash

tmux_wrapper_main(){
  if [ -z "$tmux_wrapper_file" ]; then
    tmux_wrapper_file=~/.tmux.conf
  fi
  if [ -z "$tmux_wrapper_work_path" ]; then
    tmux_wrapper_work_path=~/.tmux.wrapper
  fi
  if [ -z "$tmux_wrapper_term" ]; then
    tmux_wrapper_term=xterm-256color
  fi
  if [ -z "$tmux_wrapper_host" ]; then
    tmux_wrapper_host=localhost
  fi
  if [ -z "$tmux_wrapper_shell" ]; then
    tmux_wrapper_shell=bash
  fi
  if [ -z "$tmux_wrapper_color" ]; then
    tmux_wrapper_color=green
  fi

  if [ -z "$tmux_wrapper_id_prefix" ]; then
    tmux_wrapper_id_prefix=hosts
  fi
  if [ -z "$tmux_wrapper_id" ]; then
    tmux_wrapper_id=${0#*$tmux_wrapper_id_prefix/}
    tmux_wrapper_id="tmux-${tmux_wrapper_id//\//-}"
  fi
  if [ -z "$tmux_wrapper_session" ]; then
    tmux_wrapper_session="$(basename $0)"
  fi

  if [ ! -d "$tmux_wrapper_work_path" ]; then
    mkdir -p "$tmux_wrapper_work_path"
  fi

  tmux_wrapper_work=$tmux_wrapper_work_path/$tmux_wrapper_id.conf
  tmux_wrapper_socket=$tmux_wrapper_work_path/$tmux_wrapper_id.sock

  if [ "$tmux_wrapper_host" == localhost ]; then
    tmux_status_cmd=uptime
  else
    tmux_status_cmd="ssh $tmux_wrapper_host uptime"
  fi

  cp "$tmux_wrapper_file" "$tmux_wrapper_work"
  echo >> "$tmux_wrapper_work"
  echo "# generated by tmux-wrapper" >> "$tmux_wrapper_work"
  echo >> "$tmux_wrapper_work"
  echo 'set -g default-terminal "'$tmux_wrapper_term'"' >> "$tmux_wrapper_work"
  echo 'set -g status-left "#[fg='$tmux_wrapper_color']<'$tmux_wrapper_session'>"' >> "$tmux_wrapper_work"
  echo 'set -g status-right "#[fg='$tmux_wrapper_color'][#('$tmux_status_cmd' | sed '"'s/.*load average: //'"')]"' >> "$tmux_wrapper_work"

  tmux_wrapper_build_bind

  tmux_wrapper_exec
}
tmux_wrapper_build_bind(){
  :
}
tmux_wrapper_bind(){
  if [ -z "$tmux_wrapper_initial_window_name" ]; then
    tmux_wrapper_initial_window_name=$2
  fi
  if [ -z "$tmux_wrapper_initial_window_path" ]; then
    tmux_wrapper_initial_window_path=$3
  fi
  echo bind $1 neww -n $2 '"ssh '$tmux_wrapper_host' -t '"'cd $3; $tmux_wrapper_shell'"'"' >> "$tmux_wrapper_work"
}
tmux_wrapper_exec(){
  local cmd;

  if tmux -S "$tmux_wrapper_socket" has -t "$tmux_wrapper_session" 2> /dev/null; then
    tmux -S "$tmux_wrapper_socket" source "$tmux_wrapper_work"
    tmux -S "$tmux_wrapper_socket" attach -t "$tmux_wrapper_session"
    return
  fi

  if [ "$tmux_wrapper_host" == localhost ]; then
    cmd=$tmux_wrapper_shell
  else
    cmd="ssh $tmux_wrapper_host"
  fi

  if [ -z "$tmux_wrapper_initial_window_name" ]; then
    tmux_wrapper_exec_bare
    return
  fi
  if [ -z "$tmux_wrapper_initial_window_path" ]; then
    tmux_wrapper_exec_bare
    return
  fi

  if [ "$tmux_wrapper_host" == localhost ]; then
    cmd="$cmd -c"
  else
    cmd="$cmd -t"
  fi
  cmd="$cmd 'cd $tmux_wrapper_initial_window_path; $tmux_wrapper_shell'"

  tmux -u -S "$tmux_wrapper_socket" -f "$tmux_wrapper_work" new -s "$tmux_wrapper_session" -n "$tmux_wrapper_initial_window_name" "$cmd"
}
tmux_wrapper_exec_bare(){
  tmux -u -S "$tmux_wrapper_socket" -f "$tmux_wrapper_work" new -s "$tmux_wrapper_session" -n "$tmux_wrapper_session" "$cmd"
}
